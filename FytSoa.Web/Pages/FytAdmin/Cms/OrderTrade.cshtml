@page
@using FytSoa.Extensions
@using FytSoa.Service.DtoModel.Wx
@inject FytSoa.Service.Interfaces.Cms.ICmsMerchantService ms
@inject FytSoa.Service.Interfaces.ISysAdminService adminservice
@inject FytSoa.Service.Interfaces.ICmsShopService shopService
@{
    ViewBag.Title = "支付记录查询";
    var isSys = await HttpContext.IsSystem();
    var admin_guid = await HttpContext.LoginUserId();
    var admin = await adminservice.GetModelAsync(p => p.Guid == admin_guid);
    var ms_list = (await ms.GetListAsync(p => (isSys || p.admin_guid == admin_guid || p.admin_guid == admin.data.CreateBy) && p.status, p => p.id, Common.DbOrderEnum.Asc)).data;
}
<div id="container">
    <div class="list-wall">
        <div class="layui-form list-search">
            <form autocomplete="off" id="searchform">
                <div>
                    <span class="layui-inline">子商户：</span>
                    <div class="layui-inline">
                        @Html.DropDownList("out_sub_mch_id", ms_list.Select(p => new SelectListItem { Text = p.name, Value = p.out_sub_mch_id }), new { lay_search = "" })
                    </div>
                    <span class="layui-inline">门店：</span>
                    <div class="layui-inline">
                        <div type="text" id="out_shop_id" style="width:200px"></div>
                    </div>
                    @*<span class="layui-inline">工号：</span>
                    <div class="layui-inline">
                        @Html.DropDownList("out_sub_mch_id", ms_list.Select(p => new SelectListItem { Text = p.name, Value = p.out_sub_mch_id }), new { lay_search = "" })
                    </div>*@
                </div>
                <div style="margin-top:10px">
                    <span class="layui-inline">交易日期：</span>
                    <div class="layui-inline">
                        <input type="text" class="layui-input" id="trade_date" style="width:300px">
                        <input type="hidden" name="start_time" />
                        <input type="hidden" name="end_time" />
                    </div>
                    <span class="layui-inline">支付渠道：</span>
                    <div class="layui-inline">
                        <div id="pay_platform" style="width:200px" data-json='@Html.Raw(Json.Serialize(typeof(PayPlatform).ToDropdown().Select(p=>new { name=p.Text,value=p.Value})))'></div>
                    </div>
                </div>
                <button type="submit" class="layui-btn layui-btn-sm" data-type="toolSearch"><i class="layui-icon layui-icon-search"></i> 搜索</button>
            </form>
        </div>
        <table class="layui-hide" id="tablist" lay-filter="tool"></table>
        <script type="text/html" id="tool">
            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail"><i class="layui-icon">&#xe702;</i> 详情</a>
            <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="refund"><i class="layui-icon">&#xe65e;</i> 退款</a>
        </script>
    </div>
</div>
@section styles{
    <style>
        .loading, .uploading {
            margin-left: 0;
            width: 100%;
        }
    </style>
}
@section scripts{
    <script src="~/themes/js/xm-select.js"></script>
    <script>
        layui.config({
            base: '/themes/js/modules/'
        }).use(['table', 'jquery', 'common', 'laydate'],
            function () {
                var table = layui.table,
                    $ = layui.jquery,
                    dt = layui.laydate,
                    os = layui.common;
                var pp = xmSelect.render({ el: '#pay_platform', data: $('#pay_platform').data('json') });
                xmSelect.render({
                    el: '#out_shop_id',
                    name: 'out_shop_id',
                    radio: true,
                    filterable: true,
                    remoteSearch: true,
                    remoteMethod: (val, cb, show) => os.ajax('api/shop/getbymch', { key: val, out_sub_mch_id: $('#out_sub_mch_id').val() }, (res) => cb(res)),
                });
                table.render({
                    elem: '#tablist',
                    method: 'post',
                    contentType: 'application/json',
                    headers: os.getToken(),
                    request: {
                        pageName: 'page_num',
                        limitName: 'page_size'
                    },
                    url: '/api/sync/trade',
                    cols: [
                        [
                            { field: 'sub_pay_platform', title: '支付渠道', width: 120 },
                            { field: 'out_trade_no', title: '流水单号', width: 260 },
                            { field: 'shop_name', title: '门店名称' },
                            { title: '订单金额', templet: (d) => d.total_fee.tc(), width: 150, align: 'right' },
                            { field: 'record_current_trade_state', title: '支付状态', width: 120, align: 'center' },
                            { align: 'center', title: '创建时间', width: 160, templet: (d) => layui.util.toDateString(d.time_end, 'yyyy-MM-dd HH:mm:ss') },
                            { field: 'device_id', title: '设备号', width: 200 },
                            { field: 'staff_name', title: '店员名', width: 120, align: 'center' },
                            { title: '手续费', templet: (d) => d.poundage.tc(), width: 100, align: 'right' },
                            { title: '操作', align: 'center', templet: '#tool', width: 180 }
                        ]
                    ],
                    where: data(),
                    page: true,
                    id: 'tables'
                });
                dt.render({
                    elem: '#trade_date',
                    type: 'datetime',
                    range: '~',
                    done: (text) => {
                        var dd = text.split('~');
                        $('input[name=start_time]').val(dd[0]);
                        $('input[name=end_time]').val(dd[1]);
                    }
                });
                $('#searchform').on('submit', () => {
                    table.reload('tables',
                        {
                            page: {
                                curr: 1
                            },
                            where: data()
                        });
                    return false;
                });
                function data() {
                    var _data = $('#searchform').serializeArray().js();
                    _data['sub_pay_platforms'] = pp.getValue('value');
                    return _data;
                }
            });
    </script>
}